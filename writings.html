<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Writings — MGO_radio</title>
  <link rel="stylesheet" href="assets/site.css">
  <style>
    body {
      background: #000;
      margin: 0;
      min-height: 100vh;
    }
  </style>
</head>

<body class="witing-page">
  <a href="index.html" class="back-arrow" aria-label="Back to index">←</a>

  <main>
    <div class="writing-shell">

      <!-- Colonne gauche : titre + arborescence -->
      <aside class="writing-nav">
        <a href="writings.html" class="writing-heading">MGO</a>
        <div class="writing-divider"></div>

        <ul class="writing-tree">
          <!-- SECTION 1 : WRITINGS (manuel) -->
          <li class="tree-item">
            <button
              class="tree-label tree-root js-toggle-branch"
              data-target="writings-branch"
            >
              Writings
            </button>

            <ul class="tree-children" id="writings-branch">
              <li>
                <button
                  class="tree-sublabel js-show-list"
                  data-list="writings-university"
                  data-title="Writings — University"
                >
                  University
                </button>
              </li>

              <li>
                <button
                  class="tree-sublabel js-show-list"
                  data-list="writings-other"
                  data-title="Writings — Other"
                >
                  Other
                </button>
              </li>
            </ul>
          </li>

          <!-- SECTION 2 : READINGS (Are.na) -->
          <li class="tree-item">
            <button
              class="tree-label tree-root js-toggle-branch"
              data-target="readings-branch"
            >
              Readings
            </button>

            <ul class="tree-children" id="readings-branch">
              <li>
                <button
                  class="tree-sublabel js-show-list"
                  data-list="readings-current"
                  data-title="Readings — Current"
                >
                  Current
                </button>
              </li>

              <li>
                <button
                  class="tree-sublabel js-show-list"
                  data-list="readings-library"
                  data-title="Readings — Library"
                >
                  Library
                </button>
              </li>
            </ul>
          </li>

        </ul>
      </aside>

      <!-- Colonne droite : contenu -->
      <section class="writing-content">
        <!-- Titre mis à jour au clic -->
        <h1 class="writing-title"></h1>

        <!-- Writings → University (manuel) -->
        <ul class="writing-list" data-list-id="writings-university">
          <li>
            <a class="writing-link" href="assets/pdfs/example_university_1.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>

          <li>
            <a class="writing-link" href="assets/pdfs/example_university_2.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>

          <li>
            <a class="writing-link" href="assets/pdfs/example_university_3.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>
        </ul>

        <!-- Writings → Other (manuel) -->
        <ul class="writing-list" data-list-id="writings-other">
          <li>
            <a class="writing-link" href="assets/pdfs/example_other_1.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>

          <li>
            <a class="writing-link" href="assets/pdfs/example_other_2.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>

          <li>
            <a class="writing-link" href="assets/pdfs/example_other_3.pdf" target="_blank" rel="noopener noreferrer">
              <div class="bookwrapper">
                <div class="bookwrapper__anchor"></div>
                <div class="book">
                  <div class="book__back"></div>
                  <div class="book__spine"></div>
                  <div class="book__front">
                    <span class="book__title writing-card-title">
                      
                    </span>
                    <span class="book__author writing-card-meta">
                      
                    </span>
                  </div>
                </div>
              </div>
            </a>
          </li>
        </ul>

        <!-- Readings → Current (Are.na : MGO_readings_curr) -->
        <ul
          class="writing-list writing-list--arena"
          data-list-id="readings-current"
          data-arena-channel="mgo_reading_curr"
        ></ul>

        <!-- Readings → Library (Are.na : MGO_readings_lib) -->
        <ul
          class="writing-list writing-list--arena"
          data-list-id="readings-library"
          data-arena-channel="mgo_reading_lib"
        ></ul>
      </section>

    </div>
  </main>

<script>
/* =========================
   MAPPING ARE.NA
   ========================= */

// Quel sous-dossier pointe vers quel channel Are.na
const ARENA_CHANNELS = {
  "readings-current": "mgo_reading_curr", // slug exact
  "readings-library": "mgo_reading_lib"   // slug exact
};

const ARENA_API_BASE = "https://api.are.na/v2/channels/";
const DEBUG_ARENA    = false;

// JSON tags/meta (local)
let ITEMS_DATA = {};

document.addEventListener("DOMContentLoaded", async () => {

  /* =========================
     0) Load items.json (pour tags des books)
     ========================= */
  try {
    const r = await fetch("assets/data/items.json", { cache: "no-store" });
    if (r.ok) ITEMS_DATA = await r.json();
  } catch {
    ITEMS_DATA = {};
  }

  /* =========================
     NAV : toggle branches + changement de liste
     ========================= */
  document.addEventListener("click", (e) => {
    // 1) Ouvrir / fermer les branches (Writings / Readings)
    const branchBtn = e.target.closest(".js-toggle-branch");
    if (branchBtn) {
      const branch = document.getElementById(branchBtn.dataset.target);
      if (!branch) return;
      const item = branchBtn.closest(".tree-item");
      if (item) item.classList.toggle("is-open");
    }

    // 2) Clic sur un sous-item (University, Other, Current, Library)
    const listBtn = e.target.closest(".js-show-list");
    if (listBtn) {
      const targetKey = listBtn.dataset.list;
      const newTitle  = listBtn.dataset.title || "";

      const titleEl = document.querySelector(".writing-title");
      if (titleEl) titleEl.textContent = newTitle;

      const lists = document.querySelectorAll(".writing-list");
      lists.forEach((ul) => ul.classList.remove("is-active"));

      const activeList = document.querySelector('.writing-list[data-list-id="' + targetKey + '"]');
      if (activeList) {
        activeList.classList.add("is-active");

        const slug = ARENA_CHANNELS[targetKey];
        if (slug && !activeList.dataset.loaded) {
          loadArenaChannelIntoList(slug, activeList);
        }
      }
    }
  });

  /* =========================
     Tous les liens .writing-link → nouvel onglet
     ========================= */
  document.querySelectorAll(".writing-link").forEach((link) => {
    if (!link.target) {
      link.target = "_blank";
      link.rel    = "noopener noreferrer";
    }
  });

  /* =========================
     FONCTION : charger un channel Are.na dans une <ul>
     ========================= */
  async function loadArenaChannelIntoList(slug, listEl) {
    if (!slug || !listEl) return;

    let page = 1;
    const per = 40;
    let hasMore = true;
    const seenHrefs = new Set();
    let loadedCount = 0;

    if (DEBUG_ARENA) console.log("Are.na channel:", slug);

    try {
      while (hasMore) {
        const url =
          ARENA_API_BASE + encodeURIComponent(slug) +
          "?page=" + page +
          "&per=" + per +
          "&direction=desc" +
          "&cacheBust=" + Date.now();

        if (DEBUG_ARENA) console.log("→ fetch:", url);

        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          console.error("Erreur Are.na", res.status, url);
          break;
        }

        const data = await res.json();
        const contents = data.contents || [];

        contents.forEach((block) => {
          const li = createArenaCardFromBlock(block, seenHrefs);
          if (li) {
            listEl.appendChild(li);
            loadedCount++;
          }
        });

        hasMore = contents.length === per;
        page++;
      }

      listEl.dataset.loaded = "1";

      if (loadedCount === 0) {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="bookwrapper">
            <div class="bookwrapper__anchor"></div>
            <div class="book">
              <div class="book__back"></div>
              <div class="book__spine"></div>
              <div class="book__front">
                <span class="book__title writing-card-title">Channel unavailable</span>
                <span class="book__author writing-card-meta">No readable blocks found in “${escapeHtml(slug)}”.</span>
              </div>
            </div>
          </div>
        `;
        listEl.appendChild(li);
      }

    } catch (err) {
      console.error("Erreur en chargeant Are.na:", err);
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="bookwrapper">
          <div class="bookwrapper__anchor"></div>
          <div class="book">
            <div class="book__back"></div>
            <div class="book__spine"></div>
            <div class="book__front">
              <span class="book__title writing-card-title">Channel error</span>
              <span class="book__author writing-card-meta">Unable to load channel “${escapeHtml(slug)}”.</span>
            </div>
          </div>
        </div>
      `;
      listEl.appendChild(li);
    }
  }

  /* =========================
     FONCTION : transformer un block Are.na en book
     + Tags depuis items.json (même rendu que partout)
     ========================= */
  function createArenaCardFromBlock(block, seenHrefs) {
    if (DEBUG_ARENA) {
      console.log("[ARENA BLOCK]", "id:", block.id, "class:", block.class, "title:", block.title);
    }

    const title = block.title || "(untitled)";
    let meta = "";

    if (block.class === "Image") meta = "Image";
    else if (block.class === "Attachment") {
      const type = block.attachment?.content_type || "";
      if (type.includes("pdf")) meta = "PDF";
      else if (type.startsWith("application/")) meta = type.replace("application/", "").toUpperCase();
      else meta = "File";
    }
    else if (block.class === "Link") meta = "Link";

    let href = null;
    if (block.class === "Image" && block.image?.display?.url) href = block.image.display.url;
    else if (block.class === "Attachment" && block.attachment?.url) href = block.attachment.url;
    else if (block.class === "Link" && block.source?.url) href = block.source.url;
    else return null;

    if (href && seenHrefs.has(href)) return null;
    if (href) seenHrefs.add(href);

    // ===== Tags depuis items.json (match arena_block_id == block.id) =====
    const blockIdNum = Number(block.id);
    const jsonEntry = Object.values(ITEMS_DATA).find(v => Number(v?.arena_block_id) === blockIdNum);
    const tagsArr = Array.isArray(jsonEntry?.tags) ? jsonEntry.tags : [];

    const tagsHtml = tagsArr.length
      ? `
        <div class="tags book__tags book__tags--black">
          ${tagsArr.map(t => {
            const T = String(t).trim().toUpperCase();
            return `
              <a href="tag-index.html?tag=${encodeURIComponent(String(t).trim().toLowerCase())}" class="tag-link">
                <div class="tag-wrapper">
                  <span class="tag-text">${escapeHtml(T)}</span>
                </div>
              </a>
            `;
          }).join("")}
        </div>
      `
      : "";

    const li = document.createElement("li");
    li.innerHTML = `
      <a class="writing-link" href="${escapeHtml(href)}" target="_blank" rel="noopener noreferrer">
        <div class="bookwrapper">
          <div class="bookwrapper__anchor"></div>
          <div class="book">
            <div class="book__back"></div>
            <div class="book__spine"></div>
            <div class="book__front">
              <span class="book__title writing-card-title">${escapeHtml(title)}</span>
              ${meta ? `<span class="book__author writing-card-meta">${escapeHtml(meta)}</span>` : ``}
              ${tagsHtml}
            </div>
          </div>
        </div>
      </a>
    `;
    return li;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (s) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[s]));
  }

});
</script>

  </body>
</html>